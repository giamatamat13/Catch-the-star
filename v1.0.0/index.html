<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תפוס את הכוכבים - משחק שלבים</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #1a237e);
            font-family: 'Arial', sans-serif;
            color: white;
            overflow: hidden;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 70vh;
            border: 3px solid #fff;
            border-radius: 15px;
            background: radial-gradient(circle at center, #0f1419, #1a237e);
            overflow: hidden;
            cursor: none;
        }
        
        #gameInfo {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
        }
        
        .info-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        #score { color: #ffeb3b; font-weight: bold; }
        #lives { color: #f44336; font-weight: bold; }
        #combo { color: #4caf50; font-weight: bold; }
        #shield { color: #2196f3; font-weight: bold; }
        #stageGoal { color: #ff9800; font-weight: bold; font-size: 18px; }
        
        #stageInfo {
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 2px solid #4caf50;
        }
        
        .star {
            position: absolute;
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.1s;
            animation: twinkle 1.5s infinite alternate;
        }
        
        .star-gold { color: #ffd700; font-size: 35px; }
        .star-silver { color: #c0c0c0; font-size: 32px; }
        .star-blue { color: #4169e1; font-size: 28px; }
        .star-rainbow { font-size: 40px; animation: rainbow 2s infinite linear, twinkle 1.5s infinite alternate; }
        
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .star:hover {
            transform: scale(1.2);
        }
        
        @keyframes twinkle {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .bomb {
            position: absolute;
            font-size: 25px;
            cursor: pointer;
            animation: rotate 2s infinite linear;
        }
        
        .powerup {
            position: absolute;
            font-size: 30px;
            cursor: pointer;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #player {
            position: absolute;
            font-size: 40px;
            pointer-events: none;
            z-index: 10;
            transition: transform 0.1s;
        }
        
        .player-shield {
            box-shadow: 0 0 20px #2196f3;
            animation: shieldGlow 1s infinite alternate;
        }
        
        @keyframes shieldGlow {
            0% { box-shadow: 0 0 20px #2196f3; }
            100% { box-shadow: 0 0 30px #64b5f6; }
        }
        
        #gameOver, #stageComplete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffeb3b;
            display: none;
            z-index: 100;
        }
        
        #stageComplete {
            border-color: #4caf50;
        }
        
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .retry-btn {
            background: #ff9800;
        }
        
        .retry-btn:hover {
            background: #f57c00;
        }
        
        #instructions {
            text-align: center;
            margin-bottom: 10px;
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .combo-text, .points-text {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 50;
        }
        
        .combo-text { color: #4caf50; font-size: 20px; }
        .points-text { color: #ffeb3b; }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        #legend {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="instructions">
        השג את יעד הנקודות לעבור לשלב הבא! תפוס כוכבים ברצף לקבלת בונוס קומבו
    </div>
    
    <div id="stageInfo">
        <div id="stageTitle">שלב 1: התחלה</div>
        <div id="stageGoal">יעד: 100 נקודות</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%">
                <div class="progress-text" id="progressText">0 / 100</div>
            </div>
        </div>
    </div>
    
    <div id="legend">
        <div class="legend-item">⭐ רגיל (5)</div>
        <div class="legend-item">🌟 כחול (10)</div>
        <div class="legend-item">💫 כסף (20)</div>
        <div class="legend-item">🌠 זהב (50)</div>
        <div class="legend-item">🎆 קשת (100)</div>
        <div class="legend-item">🛡️ מגן</div>
        <div class="legend-item">❤️ חיים</div>
        <div class="legend-item">⚡ מהירות</div>
        <div class="legend-item">💥 פצצה</div>
    </div>
    
    <div id="gameInfo">
        <div class="info-section">
            <span id="score">נקודות: 0</span>
            <span id="combo">קומבו: x1</span>
        </div>
        <div class="info-section">
            <span id="lives">חיים: 3</span>
            <span id="level">רמה פנימית: 1</span>
        </div>
        <div class="info-section">
            <span id="shield">מגן: 0</span>
            <span id="speed">מהירות: רגיל</span>
        </div>
    </div>
    
    <div id="gameContainer">
        <div id="player">🎯</div>
        
        <div id="gameOver">
            <h2>נכשלת בשלב!</h2>
            <p>ניקוד: <span id="failScore">0</span> מתוך <span id="failTarget">0</span></p>
            <button class="retry-btn" onclick="retryStage()">נסה שוב</button>
            <button onclick="restartGame()">התחל מחדש</button>
        </div>
        
        <div id="stageComplete">
            <h2>כל הכבוד! עברת את השלב!</h2>
            <p>שלב <span id="completedStage">1</span> הושלם בהצלחה!</p>
            <p>ניקוד השלב: <span id="stageScore">0</span></p>
            <p>קומבו מקסימלי: <span id="stageMaxCombo">1</span></p>
            <p>זמן השלב: <span id="stageTime">0</span> שניות</p>
            <div id="totalStats" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #666;">
                <h3>סטטיסטיקות כוללות:</h3>
                <p>סה"כ נקודות: <span id="totalScore">0</span></p>
                <p>שלבים שהושלמו: <span id="totalStages">0</span></p>
                <p>קומבו מקסימלי כולל: <span id="totalMaxCombo">1</span></p>
            </div>
            <button onclick="nextStage()">שלב הבא</button>
        </div>
    </div>

    <script>
        let currentStage = 1;
        let score = 0;
        let lives = 3;
        let internalLevel = 1;
        let gameRunning = true;
        let starSpeed = 2;
        let spawnRate = 0.02;
        let bombChance = 0.1;
        let combo = 1;
        let comboCount = 0;
        let maxCombo = 1;
        let stageMaxCombo = 1;
        let shieldTime = 0;
        let speedBoostTime = 0;
        let lastStarType = null;
        let stageStartTime = Date.now();
        
        // סטטיסטיקות כוללות
        let totalScore = 0;
        let totalStages = 0;
        let totalMaxCombo = 1;
        
        // הגדרות שלבים
        const stages = [
            { target: 100, title: "התחלה", description: "למד את הבסיסים" },
            { target: 200, title: "מתחמם", description: "יותר מהר ויותר פצצות" },
            { target: 350, title: "מאתגר", description: "קומבו הוא המפתח" },
            { target: 500, title: "מתקדם", description: "זמן לפאוור-אפים" },
            { target: 700, title: "מקצועי", description: "מהירות וזריזות" },
            { target: 950, title: "מומחה", description: "רק הטובים ביותר" },
            { target: 1250, title: "אמן כוכבים", description: "כמעט בלתי אפשרי" },
            { target: 1600, title: "אגדה", description: "האתגר הסופי!" }
        ];
        
        const gameContainer = document.getElementById('gameContainer');
        const player = document.getElementById('player');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const levelElement = document.getElementById('level');
        const comboElement = document.getElementById('combo');
        const shieldElement = document.getElementById('shield');
        const speedElement = document.getElementById('speed');
        const gameOverDiv = document.getElementById('gameOver');
        const stageCompleteDiv = document.getElementById('stageComplete');
        const stageTitle = document.getElementById('stageTitle');
        const stageGoal = document.getElementById('stageGoal');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        let mouseX = gameContainer.clientWidth / 2;
        let mouseY = gameContainer.clientHeight / 2;
        
        // סוגי כוכבים עם הסתברויות ונקודות
        const starTypes = [
            { emoji: '⭐', points: 5, chance: 0.4, class: 'star-regular' },
            { emoji: '🌟', points: 10, chance: 0.3, class: 'star-blue' },
            { emoji: '💫', points: 20, chance: 0.15, class: 'star-silver' },
            { emoji: '🌠', points: 50, chance: 0.08, class: 'star-gold' },
            { emoji: '🎆', points: 100, chance: 0.02, class: 'star-rainbow' }
        ];
        
        const powerups = [
            { emoji: '🛡️', type: 'shield', chance: 0.04 },
            { emoji: '❤️', type: 'life', chance: 0.03 },
            { emoji: '⚡', type: 'speed', chance: 0.04 }
        ];
        
        // עדכון מיקום השחקן
        gameContainer.addEventListener('mousemove', (e) => {
            const rect = gameContainer.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            player.style.left = (mouseX - 20) + 'px';
            player.style.top = (mouseY - 20) + 'px';
        });
        
        function updateStageInfo() {
            const stage = stages[currentStage - 1];
            if (stage) {
                stageTitle.textContent = `שלב ${currentStage}: ${stage.title}`;
                stageGoal.textContent = `יעד: ${stage.target} נקודות`;
                updateProgress();
            }
        }
        
        function updateProgress() {
            const stage = stages[currentStage - 1];
            if (stage) {
                const progress = Math.min((score / stage.target) * 100, 100);
                progressFill.style.width = progress + '%';
                progressText.textContent = `${score} / ${stage.target}`;
            }
        }
        
        function getRandomStarType() {
            const random = Math.random();
            let cumulative = 0;
            for (let type of starTypes) {
                cumulative += type.chance;
                if (random < cumulative) return type;
            }
            return starTypes[0];
        }
        
        function getRandomPowerup() {
            const random = Math.random();
            let cumulative = 0;
            for (let powerup of powerups) {
                cumulative += powerup.chance;
                if (random < cumulative) return powerup;
            }
            return null;
        }
        
        function showFloatingText(x, y, text, className) {
            const element = document.createElement('div');
            element.className = className;
            element.textContent = text;
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            gameContainer.appendChild(element);
            
            setTimeout(() => element.remove(), 1000);
        }
        
        // יצירת אובייקטים נופלים
        function createFallingObject() {
            if (!gameRunning) return;
            
            const random = Math.random();
            const object = document.createElement('div');
            let objectType = 'star';
            
            // קביעת סוג האובייקט
            if (random < bombChance) {
                objectType = 'bomb';
                object.className = 'bomb';
                object.textContent = '💥';
            } else {
                // סיכוי גבוה יותר לפאוור-אפים בשלבים מתקדמים
                const powerupMultiplier = Math.min(currentStage / 3, 2);
                const powerupCheck = Math.random();
                const powerup = getRandomPowerup();
                
                if (powerup && powerupCheck < (0.08 * powerupMultiplier)) {
                    objectType = 'powerup';
                    object.className = 'powerup';
                    object.textContent = powerup.emoji;
                    object.dataset.powerupType = powerup.type;
                } else {
                    const starType = getRandomStarType();
                    object.className = `star ${starType.class}`;
                    object.textContent = starType.emoji;
                    object.dataset.points = starType.points;
                    object.dataset.starType = starType.emoji;
                }
            }
            
            object.style.left = Math.random() * (gameContainer.clientWidth - 40) + 'px';
            object.style.top = '-40px';
            
            gameContainer.appendChild(object);
            
            // אנימציה של נפילה
            function fall() {
                if (!gameRunning) {
                    object.remove();
                    return;
                }
                
                const currentTop = parseInt(object.style.top);
                const fallSpeed = speedBoostTime > 0 ? starSpeed * 0.6 : starSpeed;
                object.style.top = (currentTop + fallSpeed) + 'px';
                
                // בדיקת התנגשות עם השחקן
                const objectRect = object.getBoundingClientRect();
                const playerRect = player.getBoundingClientRect();
                
                if (objectRect.left < playerRect.right &&
                    objectRect.right > playerRect.left &&
                    objectRect.top < playerRect.bottom &&
                    objectRect.bottom > playerRect.top) {
                    
                    handleCollision(object, objectType);
                    return;
                }
                
                // הסרת האובייקט אם הוא יצא מהמסך
                if (currentTop > gameContainer.clientHeight) {
                    object.remove();
                    // איפוס קומבו אם כוכב יצא מהמסך
                    if (objectType === 'star') {
                        resetCombo();
                    }
                    return;
                }
                
                requestAnimationFrame(fall);
            }
            
            requestAnimationFrame(fall);
        }
        
        function handleCollision(object, objectType) {
            const rect = object.getBoundingClientRect();
            const gameRect = gameContainer.getBoundingClientRect();
            const x = rect.left - gameRect.left;
            const y = rect.top - gameRect.top;
            
            if (objectType === 'bomb') {
                if (shieldTime > 0) {
                    showFloatingText(x, y, 'חסום!', 'combo-text');
                } else {
                    lives--;
                    updateLives();
                    showFloatingText(x, y, 'אוי!', 'points-text');
                    resetCombo();
                    if (lives <= 0) {
                        endStage(false);
                    }
                }
            } else if (objectType === 'powerup') {
                handlePowerup(object.dataset.powerupType, x, y);
            } else if (objectType === 'star') {
                const points = parseInt(object.dataset.points) * combo;
                score += points;
                updateScore();
                updateProgress();
                
                // בדיקה אם השלב הושלם
                const stage = stages[currentStage - 1];
                if (score >= stage.target) {
                    endStage(true);
                    return;
                }
                
                // עדכון קומבו
                if (lastStarType === object.dataset.starType) {
                    comboCount++;
                    if (comboCount >= 2) {
                        combo = Math.min(combo + 1, 5);
                        maxCombo = Math.max(maxCombo, combo);
                        stageMaxCombo = Math.max(stageMaxCombo, combo);
                        updateCombo();
                        showFloatingText(x, y, `קומבו x${combo}!`, 'combo-text');
                    }
                } else {
                    comboCount = 1;
                    combo = Math.max(combo - 1, 1);
                    updateCombo();
                }
                
                lastStarType = object.dataset.starType;
                showFloatingText(x, y, `+${points}`, 'points-text');
                
                // העלאת רמה פנימית
                if (score >= internalLevel * 100) {
                    levelUp();
                }
            }
            
            object.remove();
        }
        
        function handlePowerup(type, x, y) {
            switch(type) {
                case 'shield':
                    shieldTime = 360; // 6 שניות
                    player.classList.add('player-shield');
                    showFloatingText(x, y, 'מגן!', 'combo-text');
                    break;
                case 'life':
                    lives = Math.min(lives + 1, 5);
                    updateLives();
                    showFloatingText(x, y, 'חיים!', 'combo-text');
                    break;
                case 'speed':
                    speedBoostTime = 360; // 6 שניות
                    showFloatingText(x, y, 'מהירות!', 'combo-text');
                    break;
            }
        }
        
        function resetCombo() {
            combo = 1;
            comboCount = 0;
            lastStarType = null;
            updateCombo();
        }
        
        function updateScore() {
            scoreElement.textContent = `נקודות: ${score}`;
        }
        
        function updateLives() {
            livesElement.textContent = `חיים: ${lives}`;
        }
        
        function updateCombo() {
            comboElement.textContent = `קומבו: x${combo}`;
            comboElement.style.color = combo > 1 ? '#4caf50' : '#fff';
        }
        
        function updateShield() {
            if (shieldTime > 0) {
                shieldElement.textContent = `מגן: ${Math.ceil(shieldTime/60)}`;
                shieldElement.style.color = '#2196f3';
            } else {
                shieldElement.textContent = 'מגן: 0';
                shieldElement.style.color = '#666';
                player.classList.remove('player-shield');
            }
        }
        
        function updateSpeed() {
            if (speedBoostTime > 0) {
                speedElement.textContent = 'מהירות: מואץ';
                speedElement.style.color = '#ff9800';
            } else {
                speedElement.textContent = 'מהירות: רגיל';
                speedElement.style.color = '#fff';
            }
        }
        
        function levelUp() {
            internalLevel++;
            starSpeed += 0.2;
            spawnRate += 0.002;
            bombChance = Math.min(bombChance + 0.01, 0.25);
            levelElement.textContent = `רמה פנימית: ${internalLevel}`;
        }
        
        function endStage(completed) {
            gameRunning = false;
            
            if (completed) {
                // שלב הושלם בהצלחה
                const stageTime = Math.floor((Date.now() - stageStartTime) / 1000);
                totalScore += score;
                totalStages++;
                totalMaxCombo = Math.max(totalMaxCombo, stageMaxCombo);
                
                document.getElementById('completedStage').textContent = currentStage;
                document.getElementById('stageScore').textContent = score;
                document.getElementById('stageMaxCombo').textContent = stageMaxCombo;
                document.getElementById('stageTime').textContent = stageTime;
                document.getElementById('totalScore').textContent = totalScore;
                document.getElementById('totalStages').textContent = totalStages;
                document.getElementById('totalMaxCombo').textContent = totalMaxCombo;
                
                stageCompleteDiv.style.display = 'block';
            } else {
                // נכשל בשלב
                const stage = stages[currentStage - 1];
                document.getElementById('failScore').textContent = score;
                document.getElementById('failTarget').textContent = stage.target;
                gameOverDiv.style.display = 'block';
            }
        }
        
        function nextStage() {
            currentStage++;
            if (currentStage > stages.length) {
                alert('מזל טוב! סיימת את כל השלבים! אתה אמן כוכבים אמיתי! 🌟');
                restartGame();
                return;
            }
            
            initStage();
            stageCompleteDiv.style.display = 'none';
        }
        
        function retryStage() {
            initStage();
            gameOverDiv.style.display = 'none';
        }
        
        function initStage() {
            score = 0;
            lives = 3;
            internalLevel = 1;
            combo = 1;
            comboCount = 0;
            stageMaxCombo = 1;
            shieldTime = 0;
            speedBoostTime = 0;
            lastStarType = null;
            gameRunning = true;
            stageStartTime = Date.now();
            
            // הגדרות בסיס לפי שלב
            starSpeed = 1.5 + (currentStage * 0.3);
            spawnRate = 0.015 + (currentStage * 0.003);
            bombChance = 0.08 + (currentStage * 0.015);
            
            updateStageInfo();
            updateScore();
            updateLives();
            updateCombo();
            updateShield();
            updateSpeed();
            levelElement.textContent = `רמה פנימית: ${internalLevel}`;
            
            // ניקוי כל האובייקטים
            const objects = gameContainer.querySelectorAll('.star, .bomb, .powerup, .combo-text, .points-text');
            objects.forEach(obj => obj.remove());
            
            gameLoop();
        }
        
        function restartGame() {
            currentStage = 1;
            totalScore = 0;
            totalStages = 0;
            totalMaxCombo = 1;
            gameOverDiv.style.display = 'none';
            stageCompleteDiv.style.display = 'none';
            initStage();
        }
        
        function gameLoop() {
            if (!gameRunning) return;
            
            // עדכון טיימרים
            if (shieldTime > 0) {
                shieldTime--;
                updateShield();
            }
            
            if (speedBoostTime > 0) {
                speedBoostTime--;
                updateSpeed();
            }
            
            // יצירת אובייקטים חדשים
            if (Math.random() < spawnRate) {
                createFallingObject();
            }
            
            setTimeout(() => requestAnimationFrame(gameLoop), 16);
        }
        
        // התחלת המשחק
        player.style.left = (mouseX - 20) + 'px';
        player.style.top = (mouseY - 20) + 'px';
        initStage();
    </script>
</body>
</html>
